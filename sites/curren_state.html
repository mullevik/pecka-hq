<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    
</head>
<body style="margin: 1em;">

    <div id="state-wrapper">

        <div class="d-flex align-items-center">
            <strong>Zjišťování stavu základny...</strong>
            <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
    </div>
   

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxqqEqsfrd1FWMlE8xQYsMcCn0ut02HZUUFI4ChmJSvUzG0h8vlQJnBNHNXP9Cp6BaX6Q/exec";

        function buildState(state) {

            const wrapper = document.getElementById("state-wrapper");
            wrapper.innerHTML = "";

            const title = document.createElement("h3");
            const lastLogStates = document.createElement("div");
            const lastLogDescription = document.createElement("p");
            const lastLogAuthor = document.createElement("figcaption");
            const lastLogInfo = document.createElement("p");
            const lastEvent = document.createElement("p");
            
            const description = state["log"]["description"];

            lastLogDescription.innerText = description === "" ? "Žádný další popis" : `„${description}“`;
            lastLogAuthor.className = "blockquote-footer";
            lastLogAuthor.innerText = `${state["log"]["person"]}, ${new Date(state["log"]["date"]).toLocaleDateString()}`;

            const start = new Date(state["event"]["start"]);
            const end = new Date(state["event"]["end"]);
            end.setDate(end.getDate() - 1);
            lastEvent.innerText = `Poslední událost: ${state["event"]["title"]} (skupina: ${state["event"]["group"]}, zodpovědná osoba: ${state["event"]["person"]}) ${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
            if (state["log_is_up_to_date"]) {
                wrapper.className = "alert alert-success";
                title.innerText = "Stav je aktuální";
                lastLogInfo.innerText = "Poslední nahlášený stav byl nahlášen až po poslední události. Lze předpokládat, že táborová základna je v tomto stavu.";
                
            } else {
                wrapper.className = "alert alert-danger";
                title.innerText = "Stav není aktuální";
                lastLogInfo.innerText = `Poslední nahlášený stav byl nahlášen před začátkem poslední rezervované události. Za poslední rezervovanou událost zodpovídá ${state["event"]["person"]}. Tato osoba by měla mít víc informací o tom, jak táborová základna aktuálně vypadá.`;
            }

            const badges = {
                "wood": "Dřevo za kuchyní", 
                "well": "Studna v pořádku", 
                "closed": "Vše správně zavřeno a zamčeno",
                "fridge": "Lednice vyprázdněná", 
                "ash": "Popel vynešen",
                "petroleum": "Dostatek petroleje",
            };
            for (const [key, value] of Object.entries(badges)) {
                const badge = document.createElement("span");
                badge.style.marginRight = "5px";
                badge.style.marginBottom = "5px";
                if (key in state["log"] && state["log"][key] === true) {
                    badge.className = "badge bg-success";
                    badge.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> ' + value + " ";
                } else {
                    badge.className = "badge bg-danger";
                    badge.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg> ' + value + " ";
                }
                lastLogStates.appendChild(badge);
            }

            wrapper.appendChild(title);
            wrapper.appendChild(lastLogStates);
            wrapper.appendChild(lastLogDescription);
            wrapper.appendChild(lastLogAuthor);
            wrapper.appendChild(lastLogInfo);
            wrapper.appendChild(lastEvent);
        }

        function failedToFetchState() {
            document.getElementById("state-wrapper").innerText = "Nepodařilo se získat informace o stavu";
        }
        
        function fetchCurrentState() {

            console.log(`Fetching`);
            
            fetch(`${API_URL}?method=currentState`, {
                method: 'GET', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': "text/plain;charset=utf-8",
                },
                redirect: "follow",
            }).then(function(response) {
                console.log(`Received`);
                console.log(response);
                return response.json();
            }).then(function(data) {
                console.log(data);
                if (data["status"] !== "ok") {
                    throw "Bad Response";
                }
                buildState(data["data"]);
            }).catch(function(e) {
                console.error(e);
                failedToFetchState();
            });
        }

        fetchCurrentState();
        console.log("Script for state fetching loaded successfully");
    </script>
</body>
