<!-- Snippet for reserving an event -->
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha512-mSYUmp1HYZDFaVKK//63EcZq4iFWFjxSL+Z3T/aCt4IO9Cejm03q3NKKYN6pFQzY0SBOr8h+eCIAZHPXcpZaNw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body style="margin: 1em;">

    <div id="loader">
        <div class="d-flex align-items-center">
            <strong>Zjišťování stavu rezervačního systému</strong>
            <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
    </div>

    <div id="admin-error" class="alert alert-danger" style="display: none;">
        Nepodařilo se získat informace z rezervačního systému. Založení žádosti o událost na Pecce nyní není možné. Prosím kontaktuj správce systému.
    </div>

    <form id="form">
        <fieldset disabled="disabled" id="fieldset">
            <div class="mb-3">
                <label for="start" class="form-label">Datum uálosti (od - do)</label>
                <div class="input-daterange input-group" id="datepicker">
                    <input type="text" class="input-sm form-control" name="start" id="start" autocomplete="off" required/>
                    <span class="input-group-text">až</span>
                    <input type="text" class="input-sm form-control" name="end" id="end" autocomplete="off" required/>
                </div>
            </div>
            <div class="mb-3">
                <label for="person" class="form-label">Kdo má událost na starost?</label>
                <input type="text" class="form-control" id="person" aria-describedby="personHelp" required placeholder="například Štof">
                <div id="personHelp" class="form-text">Stačí napsat Peckovskou přezdívku, podle které lze osobu případně dohledat a kontaktovat.</div>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="například email@example.com" required>
                <div id="emailHelp" class="form-text">Email je nutný pro vytvoření rezervace. Přijde ti na něj informace o potvrzení tvojí rezervace a následně také upozornění na vyplnění stavu základny po skončení tvé události.</div>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Telefonní číslo</label>
                <input type="text" class="form-control" id="phone" placeholder="například 710 450 777" required>
                <div id="phoneHelp" class="form-text">Telefonní číslo je nutné pro případnou možnost komunikace.</div>
            </div>
            <div class="mb-3">
                <label for="group" class="form-label">Táborová skupina</label>
                <select class="form-select" aria-label="Skupina" id="group" aria-describedby="groupHelp">
                    <option selected value="jiná">jiná</option>
                    <option value="První běh">První běh</option>
                    <option value="Druhý běh">Druhý běh</option>
                    <option value="Třetí běh">Třetí běh</option>
                    <option value="Pidi pecka">Pidi pecka</option>
                    <option value="Spolek">Spolek</option>
                </select>
                <div id="groupHelp" class="form-text">V případě osobních akcí, narozenin, Silvestrů a dalších náhodných událostí vyber skupinu <code>jiná</code>.</div>
            </div>
            
            <div class="mb-3">
                <label for="title" class="form-label">Název události</label>
                <input type="text" class="form-control" id="title" required placeholder="například 2. kolektiv prvního běhu">
            </div>

            <div class="mb-3">
                <label for="admin" class="form-label">Schvalovatel</label>
                <select class="form-select" aria-label="Skupina" id="admin" aria-describedby="adminHelp">
                    <option selected value="None">Žádná pověřená osoba není k dispozici</option>
                </select>
                <div id="adminHelp" class="form-text">Osoba, která ti bude schvalovat tvojí žádost o rezervaci. </div>
            </div>

            <div class="mb-3">
                <label for="note" class="form-label">Poznámka pro schvalovatele</label>
                <textarea class="form-control" id="note" rows="4" aria-describedby="noteHelp" maxlength="500" placeholder="Třeba popis toho, co plánuješ během události dělat ..."></textarea>
                <div id="noteHelp" class="form-text">Nějaké další informace pro tvého schvalovatele (max 500 znaků)</div>
            </div>
            

            <button type="submit" id="submit" class="btn btn-primary">Založit událost</button>
        </fieldset>
    </form>

    <div id="status" style="display: none"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.cs.min.js" integrity="sha512-spbGogUIGjhZrZqmOrIHV0T+QWHv0wtguDz5eTdfH/akeQ/dyCHCkRYcOvO4zc410n7volyHNcKtzZGFX7/mlQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>

        const API_URL = "https://script.google.com/macros/s/AKfycbyhWHySgh3a_8IIbmf9igQgBAHb8aOCxrnYh-gkSVIK4s4VDeQCvHljseejN8ShoYpwFg/exec";

        $('#datepicker').datepicker({    
            language: "cs",
        });
        
        function progress() {
            document.getElementById("submit").innerHTML = "<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Událost se zakládá ..."
            document.getElementById("submit").disabled = true;
            document.getElementById("status").style.display = "none";
        }

        function successfulReservation() {
            document.getElementById("submit").innerHTML = "Založit událost";
            document.getElementById("submit").disabled = false;
            document.getElementById("status").innerText = "Událost vytvořena. Email pro schválení žádosti byl zaslán schvalovateli." 
                + " Vyčkej prosím na email se schválením žádosti.";
            document.getElementById("status").className = "alert alert-success";
            document.getElementById("status").style.display = "block";

            document.getElementById("start").value = "";
            document.getElementById("end").value = "";
            document.getElementById("title").value = "";
        }

        function failedReservation(overlappingEvents, reason) {
            console.log("failed");
            console.log(overlappingEvents);
            document.getElementById("submit").innerHTML = "Zkusit znovu";
            document.getElementById("submit").disabled = false;
            document.getElementById("status").innerText = overlappingEvents.length > 0 ? 
                `Událost se nepodařilo vytvořit - ${reason}: ${overlappingEvents}` 
                : `Událost se nepodařilo vytvořit - ${reason}`;
            document.getElementById("status").className = "alert alert-danger";
            document.getElementById("status").style.display = "block";
        }

        function createEvent() {

            console.log(document.getElementById("start").value);
            progress();
            const data = {
                "person": document.getElementById("person").value,
                "email": document.getElementById("email").value,
                "phone": document.getElementById("phone").value,
                "title": document.getElementById("title").value,
                "group": document.getElementById("group").value,
                "admin_id": document.getElementById("admin").value,
                "note": document.getElementById("note").value,
                "start": moment(document.getElementById("start").value + " 11:00", "DD.MM.YYYY HH:mm").toDate().toISOString(),
                "end": moment(document.getElementById("end").value + " 13:00", "DD.MM.YYYY HH:mm").toDate().toISOString(),
            };
            console.log(`Sending`);
            console.log(data);
            console.log("dates", new Date(data["start"]), new Date(data["end"]));

            fetch(`${API_URL}?method=reserve`, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': "text/plain;charset=utf-8",
                },
                redirect: "follow",
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            }).then(function(response) {
                console.log(`Received`);
                console.log(response);
                return response.json();
            }).then(function(data) {
                console.log("Received body");
                console.log(data);
                
                if (data["status"] === "ok") {
                    successfulReservation();
                } else {
                    failedReservation(data["overlapping_event_names"], data["reason"]);
                }
            }).catch(function() {
                console.error("POST failed");
                failedReservation([], "Neznámá příčina");
            });
        }

        function fetchAdmins() {
            
            fetch(`${API_URL}?method=allAdmins`, {
                method: 'GET', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': "text/plain;charset=utf-8",
                },
                redirect: "follow",
            }).then(function(response) {
                console.log(`Received`);
                console.log(response);
                return response.json();
            }).then(function(data) {
                if (data["status"] !== "ok") throw "Bad response";
                successfulAdminFetch(data["data"]);
                
            }).catch(function() {
                console.error("GET failed");
                failedAdminFetch();
            });
        }

        function successfulAdminFetch(adminData) {
            const selectElement = document.getElementById("admin");
            for (let child of selectElement.children) {
                selectElement.removeChild(child);
            }

            for (let admin of adminData) {
                const optionElement = document.createElement("option");
                optionElement.value = admin["id"];
                optionElement.innerText = admin["name"];
                selectElement.appendChild(optionElement);
            }

            document.getElementById("loader").style.display = "none";
            document.getElementById("fieldset").disabled = false;
        }

        function failedAdminFetch() {
            document.getElementById("loader").style.display = "none";
            document.getElementById("admin-error").style.display = "block";
        }
    
        document.getElementById("form").addEventListener("submit", function(e){e.stopPropagation(); e.preventDefault(); createEvent(); return false;});
        fetchAdmins();
        console.log("Script for reservation submitting loaded successfully");

        // failedAdminFetch();
        // successfulAdminFetch([{"id": "ONE", "name": "One"}, {"id": "TWO", "name": "Two"}]);
        
        // failedReservation([], "No reason");
        // successfulReservation();

    </script>
</body>
