<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    
</head>
<body style="margin: 1em;">

    <form id="form">
        <div class="mb-3">
            <label for="code" class="form-label">Kód žádosti?</label>
            <input type="number" max="999999" min="100000" class="form-control" id="code" aria-describedby="codeHelp" required placeholder="například 123456">
            <div id="codeHelp" class="form-text">6-místný kód je napsaný v obdrženém emailu.</div>
        </div>

        <div class="mb-3">
            <label for="verdict" class="form-label">Verdikt</label>
            <select class="form-select" aria-label="Skupina" id="verdict" aria-describedby="verdictHelp">
                <option selected value="accept">Přijmout žádost</option>
                <option value="reject">Zamítnout žádost</option>
            </select>
            <div id="verdictHelp" class="form-text">Přijmout nebo zamítnout žádost o rezervaci události.</div>
        </div>

        <button type="submit" id="submit" class="btn btn-primary">Odeslat</button>
    </form>

    <div id="status" style="display: none"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>

        const API_URL = "https://script.google.com/macros/s/AKfycbyhWHySgh3a_8IIbmf9igQgBAHb8aOCxrnYh-gkSVIK4s4VDeQCvHljseejN8ShoYpwFg/exec";

        function success() {
            document.getElementById("submit").innerHTML = "Odesláno";
            document.getElementById("submit").disabled = true;
            document.getElementById("status").innerText = "Rozhodnutí úspěšně zaznamenáno";
            document.getElementById("status").className = "alert alert-success";
            document.getElementById("status").style.display = "block";
        }

        function failed() {
            document.getElementById("submit").innerHTML = "Zkusit znovu";
            document.getElementById("submit").disabled = false;
            document.getElementById("status").innerText = "Rozhodnutí se nepodařilo zaznamenat - kontaktuj správce systému";
            document.getElementById("status").className = "alert alert-danger";
            document.getElementById("status").style.display = "block";
        }

        function progress() {
            document.getElementById("submit").innerHTML = "<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Odesílání ..."
            document.getElementById("submit").disabled = true;
            document.getElementById("status").style.display = "none";
        }

        function submitLog() {

            progress();
            const data = {
                "code": document.getElementById("code").value,
                "approved": document.getElementById("verdict").value === "accept" ? true : false,
            };
            console.log(`Sending`);
            console.log(data);

            fetch(`${API_URL}?method=log`, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': "text/plain;charset=utf-8",
                },
                redirect: "follow",
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            }).then(function(response) {
                console.log(`Received`);
                console.log(response);
                return response.json();
            }).then(function(data) {
                console.log("Received body");
                console.log(data);
                if (data["status"] !== "ok") {
                    throw "Bad Response";
                }
                success();
            }).catch(function() {
                console.error("Failed to SEND log");
                failed();
            });
        }
    
        document.getElementById("form").addEventListener("submit", function(e){e.stopPropagation(); e.preventDefault(); submitLog(); return false;});
        console.log("Script for log submitting loaded successfully");

        // success();
        // failed();
    </script>
</body>
