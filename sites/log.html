<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">

</head>

<body style="margin: 1em;">

    <form id="form">
        <div class="mb-3">
            <label for="person" class="form-label">Kdo jsi?</label>
            <input type="text" class="form-control" id="person" aria-describedby="personHelp" required
                placeholder="například Štof">
            <div id="personHelp" class="form-text">Stačí napsat Peckovskou přezdívku, podle které tě případně dokáže
                někdo další kontaktovat a zeptat se na podrobnosti.</div>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Jak to na Pecce vypadá?</label>
            <textarea class="form-control" id="description" rows="4" aria-describedby="descriptionHelp" maxlength="500"
                placeholder="Třeba něco o tom že dochází sůl a je potřeba dokoupit novou..."></textarea>
            <div id="descriptionHelp" class="form-text">Například jaké prostředky docházejí a jsou třeba nakoupit, zda
                něco nefunguje, atd. (max 500 znaků)</div>
        </div>

        <div id="current-issues">
            <strong>Zjišťování problémů...</strong>
            <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
        <p>Nějaké nové problémy?</p>

        <div id="new-issues"></div>

        <div class="mb-3 alert alert-warning">
            <input type="text" class="form-control" id="new-issue" aria-describedby="new-issue-help"
                placeholder="například: Došel petrolej" value="">
            <div id="new-issue-help" class="form-text">Popiš stručně nový problém.</div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" id="new-issue-add" class="btn btn-outline-secondary btn-sm">Založit
                    problém</button>
            </div>
        </div>

        <button type="submit" id="submit" class="btn btn-primary">Odeslat</button>
    </form>

    <div id="status" style="display: none"></div>

    <div id="success" class="alert alert-success" role="alert" style="display: none;">Stav základny úspěšně zaznamenán.
        Obnov stránku aby ses přesvědčil.</div>
    <div id="danger" class="alert alert-danger" role="alert" style="display: none;">Něco se pokazilo - je to rozbitý.
        Zkus kontaktovat správce webu.</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script>

        const API_URL = "https://script.google.com/macros/s/AKfycbyOAOiwCxBVo1NuP0FfMSqvk46F_NRa3-lxLGXpPR5KOS9UyAfLTA8U-ahp40c70mkJXg/exec";
        let GLOBAL_NEW_ISSUE_ID = 0;

        function success() {
            document.getElementById("submit").innerHTML = "Odesláno";
            document.getElementById("submit").disabled = true;
            document.getElementById("status").innerText = `Stav základny úspěšně zaznamenán`;
            document.getElementById("status").className = "alert alert-success";
            document.getElementById("status").style.display = "block";
        }

        function failed() {
            document.getElementById("submit").innerHTML = "Zkusit znovu";
            document.getElementById("submit").disabled = false;
            document.getElementById("status").innerText = "Stav se nepodařilo odeslat";
            document.getElementById("status").className = "alert alert-danger";
            document.getElementById("status").style.display = "block";
        }

        function progress() {
            document.getElementById("submit").innerHTML = "<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Odesílání ..."
            document.getElementById("submit").disabled = true;
            document.getElementById("status").style.display = "none";
        }


        function buildCurrentIssue(issue) {
            const wrapper = document.createElement("div");
            wrapper.className = "alert alert-warning";
            const pEl = document.createElement("p");
            const sEl = document.createElement("strong");
            pEl.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> ';
            sEl.innerText = issue["description"];
            pEl.appendChild(sEl);
            pEl.appendChild(document.createTextNode(` (#${issue["id"]})`));

            const issueNumber = issue["id"];
            const radioEl = document.createElement("div");
            radioEl.innerHTML = `
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="issue-${issueNumber}-name" id="issue-${issueNumber}-persists" value="persists">
                <label class="form-check-label" for="issue-${issueNumber}-persists">Přetrvává</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="issue-${issueNumber}-name" id="issue-${issueNumber}-dunno" value="dunno">
                <label class="form-check-label" for="issue-${issueNumber}-dunno">Nevím</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="issue-${issueNumber}-name" id="issue-${issueNumber}-closed" value="closed">
                <label class="form-check-label" for="issue-${issueNumber}-closed">Vyřešeno</label>
            </div>
            `;

            wrapper.appendChild(pEl);
            wrapper.appendChild(radioEl);
            return wrapper;
        }

        function buildCurrentIssues(issues) {
            const wrapper = document.getElementById("current-issues");
            wrapper.innerHTML = "";

            for (const issue of issues) {
                wrapper.appendChild(buildCurrentIssue(issue));
            }
        }

        function buildNewIssue(newIssueDescription) {
            const newIssueId = GLOBAL_NEW_ISSUE_ID;
            GLOBAL_NEW_ISSUE_ID += 1;

            const wrapper = document.createElement("div");
            wrapper.className = "alert alert-warning";
            wrapper.id = `new-issue-${newIssueId}`;
            const pEl = document.createElement("p");
            const sEl = document.createElement("strong");
            pEl.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> ';
            sEl.innerText = newIssueDescription;
            pEl.appendChild(sEl);
            pEl.appendChild(document.createTextNode(" (nový problém)"));

            const btnEl = document.createElement("button");
            btnEl.className = "btn btn-outline-danger btn-sm";
            btnEl.innerText = "Odstranit";
            btnEl.type = "button";
            btnEl.addEventListener("click", (e) => {
                const issueToRemoveEl = document.getElementById(`new-issue-${newIssueId}`);
                issueToRemoveEl.parentNode.removeChild(issueToRemoveEl);
            });

            wrapper.appendChild(pEl);
            wrapper.appendChild(btnEl);
            return wrapper;
        }

        function fetchIssues() {
            fetch(`${API_URL}?method=issues`, {
                method: 'GET', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': "text/plain;charset=utf-8",
                },
                redirect: "follow",
            }).then(function (response) {
                console.log(`Received`);
                console.log(response);
                return response.json();
            }).then(function (data) {
                console.log(data);
                if (data["status"] !== "ok") {
                    throw "Bad Response";
                }
                buildCurrentIssues(data["data"]);
            }).catch(function (e) {
                console.error(e);
                failedToFetchCurrentIssues();
            });
        }

        function submitLog() {

            progress();
            const data = {
                "person": document.getElementById("person").value,
                "wood": document.getElementById("wood").checked,
                "well": document.getElementById("well").checked,
                "ash": document.getElementById("ash").checked,
                "closed": document.getElementById("closed").checked,
                "fridge": document.getElementById("fridge").checked,
                "petroleum": document.getElementById("petroleum").checked,
                "description": document.getElementById("description").value,
            };
            console.log(`Sending`);
            console.log(data);

            fetch(`${API_URL}?method=log`, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                headers: {
                    'Content-Type': "text/plain;charset=utf-8",
                },
                redirect: "follow",
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            }).then(function (response) {
                console.log(`Received`);
                console.log(response);
                return response.json();
            }).then(function (data) {
                console.log("Received body");
                console.log(data);
                if (data["status"] !== "ok") {
                    throw "Bad Response";
                }
                success();
            }).catch(function () {
                console.error("Failed to SEND log");
                failed();
            });
        }

        document.getElementById("form").addEventListener("submit", function (e) { e.stopPropagation(); e.preventDefault(); submitLog(); return false; });

        console.log("Script for log submitting loaded successfully");

        buildCurrentIssues([
            {
                id: 1,
                description: 'Kárka je rozbitá',
                created_at: "2022-10-31T23:00:00.000Z",
                created_by: 'Viktor',
                closed_at: '',
                closed_by: ''
            },
            {
                id: 3,
                description: 'Došel petrolej',
                created_at: "2022-10-31T23:00:00.000Z",
                created_by: 'Viktor',
                closed_at: '',
                closed_by: ''
            },
            {
                id: 5,
                description: 'Test two',
                created_at: "2022-10-31T23:00:00.000Z",
                created_by: 'Tester',
                closed_at: '',
                closed_by: ''
            }
        ]);
        document.getElementById("new-issue-add").addEventListener("click", (e) => {
            const newIssueInputEl = document.getElementById("new-issue");
            const newIssue = newIssueInputEl.value;
            newIssueInputEl.value = "";
            document.getElementById("new-issues").appendChild(buildNewIssue(newIssue));
        });

        // success();
        // failed();

    </script>
</body>