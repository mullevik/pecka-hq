<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    
</head>
<body style="margin: 1em;">

    <div id="logs-wrapper">

        <div class="d-flex align-items-center">
            <strong>Stahování stavů základny a událostí z kalendáře...</strong>
            <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
    </div>
   

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw_5pO4xyL1cVU6b2A0aRJVSzt4gfOwQy7SPpPlAX9Qe1FUyXWJbx1Bc6Lld67zDD6NHQ/exec";
       
        function buildLog(log) {
            console.log(log);
            const wrapper = document.createElement("div");
            wrapper.className = "alert alert-success";
            wrapper.style.paddingBottom = "0.1em";
            const states = document.createElement("div");
            const description = document.createElement("p");
            const author = document.createElement("figcaption");
            
            const dsc = log["description"];

            description.innerText = dsc === "" ? "Žádný další popis" : `„${dsc}“`;
            author.className = "blockquote-footer";
            author.innerText = `${log["person"]}, ${new Date(log["date"]).toLocaleDateString()}`;

            const badges = {
                "wood": "Dřevo za kuchyní", 
                "well": "Studna v pořádku", 
                "closed": "Vše správně zavřeno a zamčeno",
                "fridge": "Lednice vyprázdněná", 
                "ash": "Popel vynešen",
                "petroleum": "Dostatek petroleje",
            };
            for (const [key, value] of Object.entries(badges)) {
                const badge = document.createElement("span");
                badge.style.marginRight = "5px";
                badge.style.marginBottom = "5px";
                if (key in log && log[key] === true) {
                    badge.className = "badge bg-success";
                    badge.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> ' + value + " ";
                } else {
                    badge.className = "badge bg-danger";
                    badge.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg> ' + value + " ";
                }
                states.appendChild(badge);
            }

            wrapper.appendChild(states);
            wrapper.appendChild(description);
            wrapper.appendChild(author);

            return wrapper;
        }

        function buildEvent(event) {
            const wrapper = document.createElement("div");
            wrapper.className = "alert alert-secondary";
            wrapper.style.paddingBottom = "0.1em";
            const title = document.createElement("h4");
            const group = document.createElement("p");
            const author = document.createElement("figcaption");

            title.innerText = event["title"];
            group.innerText = `Událost skupiny: ${event["group"]}`;

            author.className = "blockquote-footer";
            const end = new Date(event["end"]);
            end.setDate(end.getDate() - 1);
            author.innerText = `${event["person"]}, ${new Date(event["start"]).toLocaleDateString()} - ${end.toLocaleDateString()}`;

            wrapper.appendChild(title);
            wrapper.appendChild(group);
            wrapper.appendChild(author);
            return wrapper;
        }
        
        function buildStates(items) {

            const wrapper = document.getElementById("logs-wrapper");
            wrapper.innerHTML = "";

            if (items.length === 0) {
                wrapper.innerText = "Nebyla nalezena žádná data";
            }

            for (let item of items) {
                if ("title" in item) {
                    wrapper.appendChild(buildEvent(item));
                } else {
                    wrapper.appendChild(buildLog(item));
                }
            }
        }

        function extractFirstDate(item) {
            if ("date" in item) {
                return new Date(item["date"]);
            } else if ("start" in item) {
                return new Date(item["start"]);
            } else {
                throw "Date can not be extracted from log/event";
            }
        }

        function sortIntoTimeLine(logs, events) {
            const items = logs.concat(events);
            
            items.sort((a, b) => {
                const aDate = extractFirstDate(a);
                const bDate = extractFirstDate(b);

                if (aDate.getTime() > bDate.getTime()) {
                    return -1;
                } else if (aDate.getTime() < bDate.getTime()) {
                    return 1;
                } else {
                    return 0;
                }
            });
            return items;
        }
        
        function fetchHistory() {

            console.log(`Fetching`);
            
            Promise.all([
                fetch(`${API_URL}?method=allLogs`).then(x => x.json()),
                fetch(`${API_URL}?method=allEvents`).then(x => x.json()),
            ]).then(([logsData, eventsData]) => {
                console.log("Received bodies", logsData, eventsData);
                if (logsData["status"] !== "ok" || eventsData["status"] !== "ok") throw "No status OK found in response";
                const dataStream = sortIntoTimeLine(logsData["data"], eventsData["data"]);
                buildStates(dataStream);
            }).catch((err) => {
                console.log(err);
                console.error("Failed to GET logs or events");
            });
        }

        fetchHistory();
        console.log("Script for history fetching loaded successfully");

        // buildStates([
        //         {
        //             date: new Date().toDateString(),
        //             person: 'Viktor',
        //             wood: false,
        //             well: false,
        //             closed: true,
        //             fridge: true,
        //             ash: true,
        //             petroleum: true,
        //             description: ''
        //         },
        //         {
        //             date: new Date().toDateString(),
        //             person: 'Viktor',
        //             wood: true,
        //             well: false,
        //             closed: true,
        //             fridge: true,
        //             ash: true,
        //         },
        //         {
        //             title: 'Testovací událost',
        //             group: 'První běh',
        //             person: 'Viktor',
        //             start: new Date().toDateString(),
        //             end: new Date().toDateString()
        //         },
        //         {
        //             title: 'Hm',
        //             group: '5. běh',
        //             person: 'Manuel',
        //             start: new Date().toDateString(),
        //             end: new Date().toDateString()
        //         }]);

    </script>
</body>
